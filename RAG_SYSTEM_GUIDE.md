# Tu2tor 平台的 RAG 系统详解

## 系统概述

Tu2tor 的 RAG（检索增强生成）系统为 AI 聊天助手增加了基于学生上传学习资料的问答能力。系统不再仅依赖 AI 的预训练知识，而是从上传的文档中检索相关内容，生成准确且与课程内容相符的回答。

## 实际应用场景

TP IIT 的学生在准备模块考试时，通常会有大量的讲义、PPT 和学习资料。RAG 系统允许他们上传这些资料（PDF、PowerPoint、Word 格式），然后直接针对内容提问。例如，一位准备数据库系统考试的学生可以上传课堂讲义，询问"INNER JOIN 和 LEFT JOIN 的区别是什么"——AI 会从上传的资料中检索相关章节，基于实际课程内容给出答案。

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    学生上传文档                              │
│              (PDF / PPTX / DOCX / 图片)                     │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              文档处理流水线                                   │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 文件类型     │→ │ 文本提取     │→ │   OCR识别    │     │
│  │ 识别         │  │ (解析器)     │  │ (Tesseract)  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                   MongoDB 数据存储                           │
│                                                              │
│  集合: knowledge_base                                       │
│  {                                                           │
│    extractedContent: {                                      │
│      fullText: "完整文本...",                               │
│      pageTexts: [                                           │
│        { pageNumber: 1, content: "第一页内容..." }         │
│      ],                                                     │
│      wordCount: 5000                                        │
│    }                                                         │
│  }                                                           │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              学生在 AI 聊天中提问                            │
│          "数据库中的规范化是什么？"                          │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                  RAG 查询流程                                │
│                                                              │
│  1. 提取关键词 → ["规范化", "数据库"]                       │
│  2. MongoDB 全文搜索                                        │
│  3. 检索相关段落 (最多 5 页)                                │
│  4. 构建上下文提示词                                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                 Gemini AI 生成回答                           │
│                                                              │
│  输入: 上下文 + 学生问题                                     │
│  输出: 带引用来源的答案                                      │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              返回答案给学生                                  │
│                                                              │
│  答案: "规范化是组织数据库数据的过程..."                    │
│  来源: [文档: "数据库讲义3", 页码: 12]                      │
└─────────────────────────────────────────────────────────────┘
```

## 数据流程详解

### 文档上传与处理

当学生向知识库上传文档时，系统会通过多个阶段进行处理。文档处理器首先检测文件类型，然后将其路由到相应的提取器。对于 PDF 文件，系统使用 `pdf-parse` 逐页提取文本。PowerPoint 文件通过 `officeparser` 处理，Word 文档则使用 `mammoth` 库。图片文件会经过 Tesseract OCR 引擎提取其中的文本内容。

每一页的文本都会单独存储在 MongoDB 中，同时保存页码、字数等元数据。这种细粒度的存储方式使得 RAG 系统能够检索特定页面而非整个文档，让上下文更加聚焦和相关。处理完成后，系统会自动为文本内容建立全文索引，为后续的快速检索做好准备。

### 知识检索流程

当学生在 RAG 模式下提问时，系统采用混合搜索策略。首先，系统从问题中提取关键词，支持中英文混合识别。提取器使用正则表达式匹配 2 个字符以上的中文词组和 3 个字符以上的英文单词，过滤掉常见的停用词，最多保留 8 个关键词以避免搜索范围过于宽泛。

系统随后在 MongoDB 中执行全文搜索，或者在学生明确选择了特定文档的情况下，直接从这些文档中检索内容。搜索会返回最相关的 3 个文档。对于每个文档，系统会逐页检查，选择那些至少匹配 2 个关键词（或在关键词较少时匹配 50%）的页面。这确保了检索到的内容高度相关，同时不会用过多的上下文信息淹没 AI。

### 上下文构建与 AI 生成

检索到的内容片段会被格式化为结构化的提示词，包含来源信息（文档标题和页码）以及实际内容。这个提示词会发送给 Gemini AI，温度参数设置为 0.3 以确保回答的一致性和事实性。

AI 被明确指示使用 `[来源 X, 页码 Y]` 的格式引用来源，让学生能够验证信息并回溯到原始资料。系统通常会处理 5-10 页的内容，在保持上下文窗口可管理的同时提供充足的信息支持准确回答。

## 技术实现细节

### 关键词提取机制

系统使用正则表达式从学生问题中提取有意义的关键词。它能够识别 2 个字符以上的中文短语和 3 个字符以上的英文单词，自动去重并限制数量。

```javascript
// 示例问题: "数据库设计中的规范化是什么？"
// 提取结果: ["数据库", "设计", "规范化"]
```

### MongoDB 文本搜索

文档使用 MongoDB 的全文搜索功能建立索引。当学生选择了特定文档时，系统会绕过文本搜索，直接通过文档 ID 检索内容，确保所有选中的资料都包含在上下文中。

```javascript
// 查询结构示例
{
  'processingStatus.status': 'completed',
  '_id': { $in: [选中的文档ID数组] },
  '$text': { $search: '规范化 数据库 设计' }
}
```

### 相关性评分算法

每一页内容都会基于关键词匹配进行评分。一页内容必须包含至少 2 个关键词，或者匹配总关键词数量的 50% 以上，才会被认为是相关的。这个机制既防止了包含不太相关的内容，又确保了对主题的全面覆盖。

### AI 提示词结构

发送给 Gemini AI 的最终提示词遵循结构化格式，引导 AI 提供有帮助且带引用的回答：

```
你是一个乐于助人的 AI 教学助手。学生选择了一些学习资料并希望与你讨论它们。

📚 可用资料:
[来源 1] "数据库讲义3" - 第12页:
规范化是组织数据库数据的过程...

❓ 学生的问题: 数据库设计中的规范化是什么？

💡 你的任务:
1. 理解学生的意图
2. 使用上面提供的资料
3. 引用来源: [来源 X, 页码 Y]
4. 保持对话性和帮助性
```

## 性能特征

RAG 系统在学生项目的约束下针对效率进行了优化。文档处理采用异步方式，最多同时处理 5 个任务，防止服务器过载。图片的 OCR 处理耗时最长（每张图片 10-30 秒），而从 PDF 或 Word 文档提取文本通常在 1-3 秒内完成。

查询响应时间取决于搜索的文档数量。当学生选择特定文档时，系统在 500 毫秒内即可检索内容。当在某个学科的所有文档中搜索时，响应时间为 1-2 秒，具体取决于语料库大小。AI 生成阶段会额外增加 2-5 秒的流式响应时间。

## 与 AI 聊天的集成

学生通过 AI 聊天界面的"知识库模式"开关访问 RAG 系统。在此模式下，他们可以选择要包含在对话中的上传文档。系统自动跟踪哪些文档处于激活状态，并在每条消息中一并发送。

聊天界面将来源引用显示为可点击的徽章，允许学生直接跳转到被引用的文档和页码。这创造了一个无缝的学习体验：学生提问、获得 AI 生成的答案、并立即对照原始资料验证信息。

## 数据存储结构

知识库使用单个 MongoDB 集合，结构如下：

```
{
  _id: ObjectId,
  userId: ObjectId,
  title: "数据库系统讲义3",
  fileUrl: "/uploads/kb/12345-lecture3.pdf",
  type: "pdf",
  subjectId: "Database Systems",
  extractedContent: {
    fullText: "完整文本...",
    pageTexts: [
      {
        pageNumber: 1,
        content: "第一页内容...",
        images: []
      }
    ],
    wordCount: 5000,
    language: "zh"
  },
  processingStatus: {
    status: "completed",
    progress: 100
  }
}
```

这种扁平化结构避免了向量数据库的复杂性，同时通过 MongoDB 的文本索引功能，在预期的规模（每个学生 50-100 个文档）下提供足够的性能。

## 系统限制与权衡

当前实现优先考虑简单性和可靠性，而非高级的语义搜索。通过使用关键词匹配和 MongoDB 文本搜索，而不是嵌入向量和向量数据库，系统避免了管理独立基础设施的复杂性，同时仍能为大多数学生查询提供有用的结果。

基于关键词的方法对于关于特定术语或概念的事实性问题效果很好，但可能会错过语义相似的内容。例如，搜索"JOIN 操作"可能不会检索到关于"表关系"的内容，即使它们概念相关。AI 的广泛知识有助于弥补这一限制，它能够理解上下文并在检索到的内容稍微偏离主题时仍提供有用的答案。

文档处理是顺序进行的，对于包含大量图片的大文件可能需要时间。一个包含嵌入图表的 50 页 PDF 可能需要 2-3 分钟才能完全处理完成。学生会通过实时更新收到处理状态通知，并且可以在后台处理继续的同时使用其他功能。

---

**最后更新:** 2025年12月20日
